version: 2.1

orbs:
  node: circleci/node@5.0.2

jobs:
  install-dependencies:
    docker:
      - image: cimg/node:18.0.0
    steps:
      - checkout
      - restore_cache:
          keys:
            - pnpm-packages-{{ checksum "pnpm-lock.yaml" }}
      - node/install-packages:
          pkg-manager: pnpm
      - save_cache:
          paths:
            - node_modules
          key: pnpm-packages-{{ checksum "pnpm-lock.yaml" }}
      - persist_to_workspace:
          root: .
          paths:
            - .

  lint:
    docker:
      - image: cimg/node:18.0.0
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Lint user app
          command: pnpm --filter user lint
      - run:
          name: Lint components package
          command: pnpm --filter @packages/components lint

  build-user-app:
    docker:
      - image: cimg/node:18.0.0
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Build user app
          command: pnpm --filter user build
      - persist_to_workspace:
          root: .
          paths:
            - apps/user/dist

  build-storybook:
    docker:
      - image: cimg/node:18.0.0
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Build Storybook
          command: pnpm --filter @packages/components build-storybook
      - persist_to_workspace:
          root: .
          paths:
            - packages/components/storybook-static

  deploy-chromatic:
    docker:
      - image: cimg/node:18.0.0
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Deploy to Chromatic
          command: pnpm --filter @packages/components chromatic

  preview-user-app:
    docker:
      - image: cimg/node:18.0.0
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Preview user app
          command: pnpm --filter user preview
          background: true
      - run:
          name: Wait for preview server
          command: |
            timeout 60s bash -c '
            until curl -s --head --request GET localhost:4173 | grep "200 OK"; do
              echo "Waiting for preview server..."
              sleep 5
            done
            '

workflows:
  version: 2
  build-test-deploy:
    jobs:
      - install-dependencies
      - lint:
          requires:
            - install-dependencies
      - build-user-app:
          requires:
            - lint
      - build-storybook:
          requires:
            - lint
      - deploy-chromatic:
          requires:
            - build-storybook
          filters:
            branches:
              only: main
      - preview-user-app:
          requires:
            - build-user-app